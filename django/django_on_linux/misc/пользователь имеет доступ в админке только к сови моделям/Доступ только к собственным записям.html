<!DOCTYPE html>
<html >
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta content='width=1024' name='viewport'>
    
    
    <title>Доступ только к собственным записям из Django админки / Песочница / Хабрахабр</title>
    
    <meta name='yandex-verification' content='67d46b975fa41645' /> <!-- яндекс вебмастер - верификация -->

        
    
    
    


    <link href="/styles/1415269022/assets/global_main.css" rel="stylesheet" media="all" />
    <script type="text/javascript" src="/javascripts/1415269022/assets/global_main.js"></script>
      <link href="/styles/1415269022/_parts/posts.css" rel="stylesheet" media="all" />
  <link href="/styles/1415269022/highlight.css" rel="stylesheet" media="all" />
  <link href="/styles/1415269022/forms.css" rel="stylesheet" media="all" />

    <link href="/styles/1415269022/printer.css" rel="stylesheet" media="print" />

    
    

    


      <script type="text/javascript" src="/javascripts/1415269022/_parts/posts.js"></script>
  <script type="text/javascript" src="/javascripts/1415269022/libs/jquery.form.js"></script>
  <script type="text/javascript" src="/javascripts/1415269022/libs/highlight.js"></script>
  <script type="text/javascript" src="/javascripts/1415269022/posts/all.js"></script>
  <script type="text/javascript" src="/javascripts/1415269022/posts/sandbox.js"></script>


      <!-- www.criteo.com/ru -->
<script type='text/javascript'>
  var crtg_nid="2580";
  var crtg_cookiename="cto_rtt";
  var crtg_varname="crtg_content";
  function crtg_getCookie(c_name){
    var i,x,y,ARRCookies=document.cookie.split(";");
    for(i=0;i<ARRCookies.length;i++){
      x=ARRCookies[i].substr(0,ARRCookies[i].indexOf("="));
      y=ARRCookies[i].substr(ARRCookies[i].indexOf("=")+1);
      x=x.replace(/^\s+|\s+$/g,"");
      if(x==c_name){return unescape(y);}
    }
    return'';
  }
  var crtg_content = crtg_getCookie(crtg_cookiename);var crtg_rnd=Math.floor(Math.random()*99999999999);
  var crtg_url=location.protocol+'//rtax.criteo.com/delivery/rta/rta.js?netId='+escape(crtg_nid);crtg_url+='&cookieName='+escape(crtg_cookiename);crtg_url+='&rnd='+crtg_rnd;crtg_url+='&varName=' + escape(crtg_varname);
  var crtg_script=document.createElement('script');crtg_script.type='text/javascript';crtg_script.src=crtg_url;crtg_script.async=true;
  if(document.getElementsByTagName("head").length>0)document.getElementsByTagName("head")[0].appendChild(crtg_script);
  else
  if(document.getElementsByTagName("body").length>0)document.getElementsByTagName("body")[0].appendChild(crtg_script);
</script>
      <script >
        var N = 5;
        var ar_duo1 = Math.floor(Math.random()*N+1);
      </script>
      <script type="text/javascript" src="/javascripts/1415269022/adriver.core.2.js"></script>

    
    
    
<script type="text/javascript">

    var user_type = "guest";

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
    ga('create', 'UA-726094-1',  'auto' ); 

  ga('require', 'displayfeatures');
  ga('set', 'dimension1', user_type); // user type - guest/readonly/habrauser
  //ga('set', 'dimension2', username); // username


  ga('send', 'pageview');
  
</script>










    <meta content='Хабрахабр' name='apple-mobile-web-app-title'>
<link href='/images/apple-touch-icon_142x142.png' rel='apple-touch-icon' type='image/png'>
  </head>

  <body>
    <div id="TMpanel">
  <div class="container">
    <div class="menu">
      <a href="http://habrahabr.ru?utm_source=tm_habrahabr&utm_medium=tm_top_panel&utm_campaign=tm_promo" class="current">Хабрахабр</a>
      <a href="http://geektimes.ru?utm_source=tm_habrahabr&utm_medium=tm_top_panel&utm_campaign=tm_promo">Geektimes</a>
      <a href="http://toster.ru?utm_source=tm_habrahabr&utm_medium=tm_top_panel&utm_campaign=tm_promo">Тостер</a>
      <a href="http://brainstorage.me?utm_source=tm_habrahabr&utm_medium=tm_top_panel&utm_campaign=tm_promo">Brainstorage</a>
      <a href="http://freelansim.ru?utm_source=tm_habrahabr&utm_medium=tm_top_panel&utm_campaign=tm_promo">Фрилансим</a>
      <a href="http://habrastorage.org?utm_source=tm_habrahabr&utm_medium=tm_top_panel&utm_campaign=tm_promo">Habrastorage</a>
    </div>
    <div class="menu special"></div>
  </div>
</div>


    <div id="layout">
      <div id="navbar_overlay" class="hidden"></div>
<div id="navbar">
    <div class="nav_panel">
        <a href="http://habrahabr.ru/" class="logo"></a>

            <a href="/posts/" class="tab tab_menu open" data-tab="menu_tab" title="Меню"><span class="g-icon g-icon-burger"></span></a>
            <a href="https://habrahabr.ru/auth/login/" class="tab tab_login" id="login" title="Войти"><span class="g-icon g-icon-lock"></span></a>

        <a href="" class="tab tab_print  hidden" id="print_tab" target="_blank" data-post-id=""></a>

        <a href="#" class="scroll_to_up hidden scroll_to_up_for_guest" id="scroll_to_top" title="Наверх"></a>
    </div>
    <div class="nav_tabs_content ">

        <div class="nav_tab hidden" id="menu_tab">
            <div class="title">Разделы</div>
            <form action="/search/" method="get" class="global_search_form">
                <div>
                    <input type="text" name="q" placeholder="Поиск" />
                </div>
            </form>
            <div class="menu">
                <a href="/posts/top/">Публикации</a>
                <a href="/hubs/">Хабы</a>
                <a href="/companies/">Компании</a>
                <a href="/users/">Пользователи</a>
                <a href="http://toster.ru/?utm_source=tm_habrahabr&utm_medium=tm_menu&utm_campaign=tm_promo"    class="new_window">Q&A</a>
                <a href="/sandbox/">Песочница</a>
                <a href="/exchange/">Биржа авторов</a>



            </div>

            

                    <div class="line"></div>
                    <div class="title">Спецпроекты</div>
                    <div class="menu">

                    <a href="/lnk/93/" target="_blank">Бесплатное облако</a>

                    <a href="/lnk/95/" target="_blank">Wargaming</a>

                    <a href="/lnk/97/" target="_blank">Brother</a>
                    </div>


        </div>


    </div>
</div>

      <div class="inner">
        
                
        

        	

  <div class="content_left">
	  





<table class="menu">
  <tr>
      <td class="item  active">
        	<a href="http://habrahabr.ru/sandbox/"  ><span class="name">Ожидают инвайт</span></a>
      </td>
      <td class="item ">
        	<a href="http://habrahabr.ru/sandbox/invited/"  ><span class="name">Получили инвайт</span></a>
      </td>
  </tr>
</table>
<div class="submenu ">
</div>
<div class="clear"></div>



			
  <div class="post" id="post_22805">
  	<div class="published"> 5 января 2011 в 21:41</div>
    <h1 class="title">
    
        <span class="post_title">Доступ только к собственным записям из Django админки</span>
      
  		
  	</h1>

	

    <div class="content html_format">
      Иногда нужно, чтобы каждый пользователь админки Django мог видеть и редактировать только свои записи. По умолчанию такая возможность не доступна, но с помощью нехитрых действий можно всё исправить.<br/>
<a name="habracut"></a><br/>
Суть подхода заключается в добавлении к нашей модели внешнего ключа на модель пользователя Django, а затем переопределение некоторых методов класса, отвечающего за генерацию админки.<br/>
<br/>
Администратор сайта видит все записи и может менять их владельцев (или создавать объекты от чужого имени). Остальные пользователи, имеющие доступ в панель администрирования, могут создавать и редактировать только свои записи.<br/>
<br/>
<h4>models.py</h4><br/>
<code><pre># -*- coding: utf-8 -*-
from django.db import models
from django.contrib.auth.models import User

class Entry(models.Model):
   user = models.ForeignKey(User, verbose_name=u&quot;пользователь&quot;, blank=True, null=True)
   title = models.CharField(u&quot;заголовок&quot;, max_length=100)

   def __unicode__(self):
      return self.title

   class Meta:
      verbose_name = u&quot;&quot;&quot;запись&quot;&quot;&quot;
      verbose_name_plural = u&quot;&quot;&quot;записи&quot;&quot;&quot;</pre></code><br/>
<br/>
Обратите внимание на атрибуты <b>blank</b> и <b>null</b> у поля user.<br/>
<br/>
Так как поле будет заполняться автоматически, то нужно разрешить Django оставлять его пустым (blank=True).<br/>
<br/>
<b>null=True</b> необходим для корректной работы нашего кода. Вообще, поле всегда будет содержать id пользователя и было бы правильно указать <b>null=False</b>, но из-за внутреннего устройства Django такой подход не пройдет.<br/>
<br/>
<h4>admin.py</h4><br/>
<code><pre># -*- coding: utf-8 -*-
from django.contrib import admin
from app.models import Entry

class EntryAdmin(admin.ModelAdmin):

   # Поля, доступные для редактирования простым пользователям.
   # Разрешаем только title
   user_fieldsets = (
     (None, {
         'classes': ('wide',),
         'fields': ('title',)
      }),
   )

   list_display = ['title', 'user']
   raw_id_list_displayfields = ('user',)
   search_fields = ['title', 'user__username']

   def save_model(self, request, obj, form, change):
      if form.is_valid():
         if not request.user.is_superuser or not form.cleaned_data[&quot;user&quot;]:
            obj.user = request.user
            obj.save()
         elif form.cleaned_data[&quot;user&quot;]:
            obj.user = form.cleaned_data[&quot;user&quot;]
            obj.save()

   def preprocess_list_display(self, request):
      if 'user' not in self.list_display:
         self.list_display.insert(self.list_display.__len__(), 'user')
      if not request.user.is_superuser:
         if 'user' in self.list_display:
            self.list_display.remove('user')

   def preprocess_search_fields(self, request):
      if 'user__username' not in self.search_fields:
         self.search_fields.insert(self.search_fields.__len__(), 'user__username')
      if not request.user.is_superuser:
         if 'user__username' in self.search_fields:
            self.search_fields.remove('user__username')

   def changelist_view(self, request, extra_context=None):
      self.preprocess_list_display(request)
      self.preprocess_search_fields(request)
      return super(EntryAdmin, self).changelist_view(request)

   def queryset(self, request):
      if request.user.is_superuser:
         return super(EntryAdmin, self).queryset(request)
      else:
         qs = super(EntryAdmin, self).queryset(request)
         return qs.filter(user=request.user)

   def get_fieldsets(self, request, obj=None):
      if request.user.is_superuser:
         return super(EntryAdmin, self).get_fieldsets(request, obj)
      return self.user_fieldsets

admin.site.register(Entry, EntryAdmin)</pre></code><br/>
Разберемся с кодом.<br/>
<br/>
Метод <b>save_model</b> отвечает за автозаполнение поля user. Несколько несложных условий подставляют необходимый id пользователя.<br/>
<br/>
Метод <b>preprocess_list_display</b> добавляет колонку user в список объектов, если его просматривает администратор и удаляет колонку для обычных пользователей. Обратите внимание, что сперва мы проверяем, есть ли запись в list_display и если её нет, то добавляем, а потом уже смотрим кто просматривает список. <br/>
При создании экземпляра EntryAdmin все его поля становятся глобальными для процесса, поэтому если мы удалим колонку list_display для обычного пользователя и не добавим для администратора, то администратор колонку не увидит. Именно поэтому мы каждый раз её вставляем в список.<br/>
<br/>
Метод <b>preprocess_search_fields</b> делает тоже, что и <b>preprocess_list_display</b>, но только для search_fields. Фактически мы дали возможность администратору не только видеть автора записи, но и осуществлять поиск по его username.<br/>
<br/>
Оба предыдущих метода вызываются из переопределенного <b>changelist_view</b>.<br/>
<br/>
Метод <b>queryset</b> возвращает все записи для администратора и персональные записи для обычных пользователей. При изменении записи, обращение к ней идет через этот самый queryset, поэтому если пользователь пытается напрямую получить доступ к чужому объекту (введет в строку браузера что-то вроде /admin/app/entry/3/), то ему вернется HTTP 404.<br/>
<br/>
Метод <b>get_fieldsets</b> подключает user_fieldsets в случае обычных пользователей или же генерирует fieldsets на основе данных модели Entry.<br/>
<br/>
Вот и все, осталось только назначить пользователям необходимые права «can add entry», «can change entry» и т.д. А также поставить галочку напротив поля «Статус персонала» на странице редактирования данных пользователя. «Статус персонала» разрешит человеку входить в административную часть сайта.

  		<div class="clear"></div>
    </div>
		
		<div class="tags">
			django, админка
		</div>
		
		
		<div class="infopanel infopanel_sandbox" id="infopanel_post_22805">
	
	<div class="sandbox_author">
		лорд Брабазон Вир-де-Вир
	</div>
	
		<div class="share">
		<div class="twitter">
			<a href="http://twitter.com/intent/tweet?text=%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF+%D1%82%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE+%D0%BA+%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%BC+%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8F%D0%BC+%D0%B8%D0%B7+Django+%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%BA%D0%B8+%23habr+http://habr.ru/sandbox/22805/" title="Опубликовать ссылку в Twitter" target="_blank"></a>
		</div>
		<div class="vkontakte">
			<a href="http://vkontakte.ru/share.php?url=http://habr.ru/sandbox/22805/" title="Опубликовать ссылку во ВКонтакте" onclick="window.open(this.href, 'Опубликовать ссылку во Вконтакте', 'width=800,height=300'); return false"></a>
		</div>
		<div class="facebook">
			<a href="https://www.facebook.com/sharer/sharer.php?u=http://habr.ru/sandbox/22805/" title="Опубликовать ссылку в Facebook" onclick="window.open(this.href, 'Опубликовать ссылку в Facebook', 'width=640,height=436,toolbar=0,status=0'); return false"></a>
		</div>
		<div class="googleplus">
			<a href="https://plus.google.com/share?url=http://habr.ru/sandbox/22805/" title="Опубликовать ссылку в Google Plus" onclick="window.open(this.href, 'Опубликовать ссылку в Google Plus', 'width=800,height=300'); return false"></a>
		</div>
		</div>
	
	
</div>
<div class="clear"></div>    
		
	</div>

			
  </div>
  <div class="sidebar_right">
      	<div class="banner_300x100">
		<!--  AdRiver code START. Type:AjaxJS Site: habrahabr PZ: 0 BN: 5 -->
		<div id="adriver_banner_2100516578"></div>
		<script type="text/javascript">
			$(function(){
				var keyword = '';
				if (typeof crtg_content !== 'undefined' && crtg_content) { keyword = crtg_content; }

				var custom = {4:ar_duo1};

				new adriver("adriver_banner_2100516578", {sid: 176776, bt: 52, bn: 5, custom: custom, keyword: keyword});
			}());
		</script>
	</div>

			<div class="block sandbox_text sandbox_text_about">
	<div class="title">Что происходит?</div>
	<p>В «Песочницу» попадают топики от людей, желающих получить инвайт на Хабр. Написал хороший топик — получил инвайт.</p>

	<p>Все публикации анонимны. Псевдонимы показываются случайным образом. Инвайт может дать тот, у кого он есть.</p>
	
</div>

      	<div class="banner_300x500">
		<div id="adriver_banner_1863387959"></div>
		<script type="text/javascript">
            function show_bn1_block(name, url){
                console.log('show' + name);
                if( typeof(name) !== 'undefined'){
                    $.get('/html/'+name+'/1415269022/', function(html){
                        $('#adriver_banner_1863387959').html(html);
                        if( typeof(url) !== 'undefined'){
                            $('.'+name+'_inner_banner .block_url').attr('href', url);
                        }
                    })
                }
            }



			$(function(){

                // конвертирут кириллицу в cp1251
                // doc: http://www.adriver.ru/doc/edu-n/pub/settargt/standtrgt/scentrgt/scentrgt.html#9
				function esc(s){
                    for(var i=0,l=s.length,r='';i<l;i++){
                        var c = s.charCodeAt(i);r += String.fromCharCode(c>1039&&c<1104 ? c-848 : c==1105 ? 184 : c==1025 ? 168 : c);
                    }
                    return r;
                }

                var keyword = '';

                if (typeof crtg_content !== 'undefined' && crtg_content) { keyword = crtg_content; }
                
                

				var custom = {4:ar_duo1};

                 new adriver("adriver_banner_1863387959", {sid: 176776, bt: 52, bn: 1, custom: custom, keyword: keyword});
			}());



            
		</script>
	</div>

			<div class="block sandbox_text sandbox_text_moderation">
	<div class="title">О модерации</div>
	<p>В разделе действует премодерация: перед публикацией все материалы проходят через заботливые руки. </p>

	<p>С большой вероятностью не пройдут премодерацию:</p>

	<p>&mdash; новости и вопросы/просьбы;	</p>
	
	<p>&mdash; статьи, ранее опубликованные на других сайтах;</p>
	
	<p>&mdash; статьи без правильно расставленных знаков препинания, со смайликами, с обилием восклицательных знаков, выделением и другим бросающимся в глаза форматированием текста;</p>
	
	<p>&mdash; обзоры софта, железа, сервисов и т.п.;</p>
	
	<p>&mdash; жалобы на компании и предоставляемые услуги;</p>
	
	<p>&mdash; переводы других статей;</p>
	
	<p>&mdash; куски программного кода;</p>
	
	<p>&mdash; статьи, не имеющие ничего общего с IT-тематикой</p>
	
</div>

  </div>
  <div class="clear"></div>


        
        	
	<div class="rotated_posts">
			<div class="rotated_post ">
				<a href="http://habrahabr.ru/post/240119/" class="grey" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block', 'posts_rotation_block'); }">Как я разработал устройство для качания детской кроватки</a>
			</div>
			<div class="rotated_post ">
				<a href="http://habrahabr.ru/company/yandex/blog/236677/" class="grey" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block', 'posts_rotation_block'); }">Илья</a>
			</div>
			<div class="rotated_post last">
				<a href="http://habrahabr.ru/post/227609/" class="grey" onclick="if (typeof ga === 'function') { ga('send', 'event', 'tm_block', 'posts_rotation_block'); }">День Александерсона — скромного великого изобретателя</a>
			</div>
		<div class="clear"></div>
	</div>

        

        
        <div class="clear"></div>

        <div class="footer_panel">
          <div id="footer">
	<dl>
		<dd><a href="https://habrahabr.ru/auth/login/">Войти</a></dd>
		<dd><a href="https://habrahabr.ru/auth/register/">Регистрация</a></dd>
	</dl>
	<dl>
		<dt>Разделы</dt>
		<dd><a href="http://habrahabr.ru/posts/top/">Публикации</a></dd>
		<dd><a href="http://habrahabr.ru/hubs/">Хабы</a></dd>
		<dd><a href="http://habrahabr.ru/companies/">Компании</a></dd>
		<dd><a href="http://habrahabr.ru/users/">Пользователи</a></dd>
		<dd><a href="http://toster.ru/?_aa=press_anykey">Q&amp;A</a></dd>
		<dd><a href="http://habrahabr.ru/sandbox/">Песочница</a></dd>
		
	</dl>	
	<dl>
		<dt>Инфо</dt>
		<dd><a href="/info/about/">О сайте</a></dd>
		<dd><a href="/info/help/rules/">Правила</a></dd>
		<dd><a href="/info/help/">Помощь</a></dd>
		<dd><a href="/info/agreement/">Соглашение</a></dd>
	</dl>
	<dl>
		<dt>Услуги</dt>
		<dd><a href="/info/advertising/">Реклама</a></dd>
		<dd><a href="/info/advertising/corporate/">Тарифы</a></dd>
		<dd><a href="/info/advertising/workshops/">Семинары</a></dd>
		<dd><a href="/special/">Спецпроекты</a></dd>
	</dl>
	<dl>
		<dt>Разное</dt>
		<dd><a href="/apps/">Приложения</a></dd>
		<dd><a href="/special/testdrive/">Тест-драйвы</a></dd>
		<dd><a href="http://special.habrahabr.ru/hello_startup/bizspark/">Помощь стартапам</a></dd>
	</dl>
	<div class="copyright">

		<div class="about">
			<a href="http://tmtm.ru/">TM</a>
			© 2006&#8211;2014
			<br><br>
			<a href="http://habrahabr.ru/feedback/">Служба поддержки</a><br><br>
			    <a href="http://m.habrahabr.ru?mobile=yes">Мобильная версия</a><br><br>
			

			<div class="social_accounts">
				<a href="https://twitter.com/habrahabr" class="tw"></a>
				<a href="https://www.facebook.com/habrahabr.ru" class="fb"></a>
				<a href="http://vk.com/habr" class="vk"></a>
				<!-- <a href="" class="gp"></a> //-->
			</div>

		</div>
	</div>

</div>    
          
        </div>
      </div>
    </div>
  

      <script type="text/javascript" src="/javascripts/1415269022/libs/jquery.cookie.js"></script>
      <script type="text/javascript">
        $(document).ready( function(){
          window.tmidLogin = function(){ return false; };
          if( $.cookie('tmid_no_check') == undefined ) {
            var expire = new Date();
            expire.setMinutes(expire.getMinutes() + 10 );
            $.cookie('tmid_no_check', 1, { expires: expire } );
            $.getScript("https://id.tmtm.ru/checklogin", function(){
              if( window.tmidLogin() ) {

                  var href = $('#login').attr('href');

                  if( href !== undefined ) {
                      window.location.href = href;
                  }
              }
            });
          }
        });
      </script>

    <script type="text/javascript">
  // global vars
  var g_base_url = 'habrahabr.ru';
  var g_show_xpanel = false;
  var g_base_fullurl = 'http://habrahabr.ru/';
  var g_is_guest = false;
</script> 

      <script type="text/javascript" src="/javascripts/1415269022/assets/shortcuts.js"></script>
    
    <script type="text/javascript" src="/javascripts/1415269022/assets/global_footer_main.js"></script>

    
    

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
(function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter24049213 = new Ya.Metrika({id:24049213,
                    webvisor:true,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
})(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="//mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

    

    <!-- Хабр не резиновый! -->
  </body>
</html>
